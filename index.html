<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Repositório de Notícias — Hedgepoint</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --hp-orange:#ED8B00; --hp-blue:#272259; --hp-black:#000000; --hp-white:#FFFFFF;
    --hp-off:#F8F9F7; --hp-gray:#4D4C4D; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--hp-off);color:var(--hp-black);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
  a{color:inherit}
  .wrap{max-width:1100px;margin:48px auto;padding:0 20px;}
  h1{font-weight:700;font-size:28px;margin:0 0 8px;}
  .sub{color:var(--hp-gray);margin:0 0 24px;font-size:14px;}

  .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:12px;align-items:end;margin:0 0 20px;}
  .control{display:flex;flex-direction:column;gap:6px;}
  .control label{font-size:12px;color:var(--hp-gray)}
  .control select,.control input{border:1px solid #ddd;border-radius:10px;padding:10px 12px;background:#fff;font:inherit;outline:none;}
  .btn{border-radius:999px;padding:10px 16px;background:var(--hp-black);color:#fff;border:none;cursor:pointer;font-weight:700;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}

  #container{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  @media (max-width:980px){#container{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:640px){#container{grid-template-columns:1fr;}}

  .card{background:#fff;border:1px solid #eee;border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;display:flex;flex-direction:column;gap:10px;}
  .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .badge{font-weight:700;font-size:12px;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;letter-spacing:.2px;max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .badge--nacional{background:var(--hp-orange);color:#fff;}
  .badge--internacional{background:var(--hp-blue);color:#fff;}
  .date{font-size:12px;color:var(--hp-gray);white-space:nowrap;}
  .title{font-weight:700;font-size:18px;line-height:1.25;margin:0;}
  .vehicle{display:flex;align-items:center;gap:10px;margin-top:2px;}
  .vehicle img{width:22px;height:22px;border-radius:50%;border:1px solid #eee;object-fit:cover;background:#fff;}
  .vehicle span{font-size:12px;color:var(--hp-gray)}
  .cta{display:flex;justify-content:flex-end;margin-top:auto;}
  .button-link{border:2px solid var(--hp-black);color:#fff;background:var(--hp-black);padding:8px 14px;border-radius:999px;font-weight:700;text-decoration:none;transition:transform .06s ease;}
  .button-link:hover{transform:translateY(-1px);}

  .list-footer{display:flex;justify-content:center;margin:24px 0 8px;}
  .empty{padding:28px;text-align:center;color:var(--hp-gray)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Repositório de Notícias</h1>
    <p id="statsLine" class="sub">Carregando…</p>

    <div class="controls" role="region" aria-label="Filtros">
      <div class="control">
        <label for="escopo">Escopo</label>
        <select id="escopo">
          <option value="">Todos</option>
          <option value="nacional">Nacional</option>
          <option value="internacional">Internacional</option>
        </select>
      </div>
      <div class="control" id="categoriaControl" hidden>
        <label for="categoria">Categoria</label>
        <select id="categoria">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="control">
        <label for="from">De</label>
        <input id="from" type="date">
      </div>
      <div class="control">
        <label for="to">Até</label>
        <input id="to" type="date">
      </div>
      <button id="apply" class="btn">Aplicar filtros</button>
    </div>

    <div id="container"></div>
    <div class="list-footer">
      <button id="loadMore" class="btn">Carregar mais</button>
    </div>
    <div id="emptyState" class="empty" style="display:none">Nenhuma notícia encontrada com os filtros atuais.</div>
  </div>

  <!-- PapaParse -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Captura erros globais e exibe no subtítulo -->
  <script>
    window.addEventListener('error', function(e){
      var el = document.getElementById('statsLine');
      if(el) el.textContent = 'Erro de script: ' + (e.message || 'desconhecido');
    });
  </script>

  <script>
  (function(){
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3Wkg0xuRA_RhRVfyS0azJ80LfzN9Ezm7Xg64J_ebTTm7S3LjmNI8BpqhjOJ-PzyjtCdCeEtfdaFSE/pub?output=csv';

    // Cabeçalhos (Logo e Commodity opcionais; filtro usa Categoria)
    const FIELD = {
      categoria:'Categoria',
      titulo:'Titulo',
      veiculo:'Veiculo',
      data:'DataPublicacao',
      url:'URL',
      escopo:'Escopo',
      commodity:'Commodity', // ignorado p/ filtro; usamos Categoria
      logo:'Logo'
    };

    const PAGE_SIZE = 9;
    let master = [], view = [], page = 0, hasCategoria = false;

    const els = {
      container: document.getElementById('container'),
      loadMore: document.getElementById('loadMore'),
      empty: document.getElementById('emptyState'),
      escopo: document.getElementById('escopo'),
      categoria: document.getElementById('categoria'),
      categoriaControl: document.getElementById('categoriaControl'),
      from: document.getElementById('from'),
      to: document.getElementById('to'),
      apply: document.getElementById('apply'),
      stats: document.getElementById('statsLine')
    };

    // ---------- Helpers
    function clean(s){
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }
    const monthsPt = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

    // Aceita ISO com/sem hora e DD/MM/YYYY com/sem hora
    function parseDateFlexible(s){
      if(!s) return null;
      s = String(s).trim();

      let t = Date.parse(s);
      if(!isNaN(t)) return new Date(t);

      let onlyDate = s.replace(/[T\s].*$/, '');
      t = Date.parse(onlyDate);
      if(!isNaN(t)) return new Date(t);

      let m = onlyDate.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3]);

      m = onlyDate.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
      if(m){
        const y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        return new Date(y, +m[2]-1, +m[1]);
      }
      return null;
    }
    function formatDatePt(d){
      if(!(d instanceof Date) || isNaN(d)) return '';
      var day=d.getDate(), mon=monthsPt[d.getMonth()], year=d.getFullYear();
      return (String(day).padStart(2,'0') + ' ' + mon + ' ' + year);
    }
    function byDateDesc(a,b){ return (b.__ts||0)-(a.__ts||0); }
    function plural(n,sing,plur){ return n===1?sing:plur; }

    function extractDomain(u){
      try{ var hostname = new URL(u).hostname; return hostname.replace(/^www\./,''); }
      catch(_){ return ''; }
    }
    function logoForItem(item){
      if(item.logo) return item.logo.trim();
      var domain = extractDomain(item.url||'');
      if(domain) return 'https://www.google.com/s2/favicons?sz=64&domain=' + encodeURIComponent(domain);
      return 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="#ddd"/></svg>');
    }

    // ---------- Normalização por linha
    function normalizeRow(r){
      var escRaw = (r[FIELD.escopo]||'');
      var escClean = clean(escRaw);
      var escNorm = '';
      if(escClean.indexOf('nac')===0) escNorm = 'nacional';
      else if(escClean.indexOf('int')===0) escNorm = 'internacional';

      var dt = parseDateFlexible(r[FIELD.data]||'');

      // Para filtro, usar Categoria; se não houver, tenta Commodity
      var categoriaRaw = (r[FIELD.categoria] || r[FIELD.commodity] || '').trim();
      var categoriaNorm = clean(categoriaRaw);
      if(categoriaRaw) hasCategoria = true;

      return {
        categoria: categoriaRaw,      // exibição
        __categoria: categoriaNorm,   // filtro
        titulo:(r[FIELD.titulo]||'').trim(),
        veiculo:(r[FIELD.veiculo]||'').trim(),
        data:(r[FIELD.data]||'').trim(),
        __date: dt?formatDatePt(dt):'',
        __ts: dt?dt.getTime():0,
        url:(r[FIELD.url]||'').trim(),
        escopo:(escRaw||'').trim(),
        __esc: escNorm,
        logo:(r[FIELD.logo]||'').trim()
      };
    }

    // ---------- Render
    function renderCard(item){
      var card = document.createElement('div');
      card.className = 'card';

      var top = document.createElement('div');
      top.className = 'top-row';

      // Badge: Escopo – Categoria
      var badge = document.createElement('span');
      var esc = item.__esc || '';
      badge.className = 'badge ' + (esc==='nacional' ? 'badge--nacional' : esc==='internacional' ? 'badge--internacional' : '');
      var badgeText = item.escopo || '—';
      if(item.categoria){ badgeText += ' – ' + item.categoria; }
      badge.textContent = badgeText;

      var date = document.createElement('span');
      date.className = 'date';
      date.textContent = item.__date || item.data || '—';

      top.appendChild(badge);
      top.appendChild(date);

      var title = document.createElement('h5');
      title.className = 'title';
      title.textContent = item.titulo || 'Sem título';

      var vehicle = document.createElement('div');
      vehicle.className = 'vehicle';

      var img = document.createElement('img');
      img.alt = '';
      img.src = logoForItem(item);
      img.onerror = function(){
        this.onerror = null;
        this.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" fill="#ddd"/></svg>');
      };

      var veicSpan = document.createElement('span');
      veicSpan.textContent = item.veiculo || '';

      vehicle.appendChild(img);
      vehicle.appendChild(veicSpan);

      var ctaWrap = document.createElement('div');
      ctaWrap.className = 'cta';

      var link = document.createElement('a');
      link.className = 'button-link';
      link.href = item.url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'Ver notícia';

      ctaWrap.appendChild(link);

      card.appendChild(top);
      card.appendChild(title);
      card.appendChild(vehicle);
      card.appendChild(ctaWrap);

      return card;
    }

    // ---------- UI helpers
    function clearGrid(){ els.container.innerHTML=''; }
    function paintNextPage(){
      var start = page*PAGE_SIZE;
      var slice = view.slice(start, start+PAGE_SIZE);
      for(var i=0;i<slice.length;i++){
        els.container.appendChild(renderCard(slice[i]));
      }
      page++;
      var hasMore = (page*PAGE_SIZE) < view.length;
      els.loadMore.style.display = hasMore ? '' : 'none';
      els.empty.style.display = view.length ? 'none' : '';
    }

    function dedupe(arr){
      var seen = Object.create(null), out = [];
      for(var i=0;i<arr.length;i++){ var v = arr[i]; if(v && !seen[v]){ seen[v]=1; out.push(v); } }
      return out;
    }
    function populateCategoriaFilter(){
      if(!hasCategoria){
        els.categoriaControl.hidden = true;
        return;
      }
      var values = master.map(function(r){ return r.categoria; }).filter(Boolean);
      var labels = dedupe(values).sort(function(a,b){ return a.localeCompare(b,'pt-BR'); });
      var html = '<option value="">Todas</option>';
      for(var i=0;i<labels.length;i++){
        html += '<option value="' + clean(labels[i]) + '">' + labels[i] + '</option>';
      }
      els.categoria.innerHTML = html;
      els.categoriaControl.hidden = false;
    }

    function isFiltering(){
      var esc = clean(els.escopo.value);
      var cat = hasCategoria ? clean(els.categoria.value) : '';
      var from = els.from.value ? Date.parse(els.from.value + 'T00:00:00') : null;
      var to   = els.to.value   ? Date.parse(els.to.value   + 'T23:59:59') : null;
      return !!(esc || cat || from || to);
    }

    function updateStats(){
      var total = master.length, current = view.length;
      if(isFiltering()){
        els.stats.textContent = 'Mostrando ' + current + ' ' + (current===1?'matéria':'matérias') +
                                ' de ' + total + ' ' + (total===1?'menção':'menções') + '.';
      }else{
        els.stats.textContent = 'Total de ' + total + ' ' + (total===1?'menção':'menções') + '.';
      }
    }

    function applyFilters(){
      var escopoVal = clean(els.escopo.value);   // '' | 'nacional' | 'internacional'
      var catVal    = hasCategoria ? clean(els.categoria.value) : '';
      var fromTs    = els.from.value ? Date.parse(els.from.value + 'T00:00:00') : null;
      var toTs      = els.to.value   ? Date.parse(els.to.value   + 'T23:59:59') : null;

      view = master.filter(function(r){
        var okEsc = !escopoVal || r.__esc === escopoVal;
        var okCat = !hasCategoria || !catVal || r.__categoria === catVal;

        // Filtro por período: se informado, exige data válida
        var okDate = true;
        if(fromTs !== null){
          okDate = okDate && (r.__ts && r.__ts >= fromTs);
        }
        if(toTs !== null){
          okDate = okDate && (r.__ts && r.__ts <= toTs);
        }

        return okEsc && okCat && okDate;
      }).sort(byDateDesc);

      page=0; clearGrid(); paintNextPage(); updateStats();
    }

    els.apply.addEventListener('click', applyFilters);
    els.loadMore.addEventListener('click', paintNextPage);

    // ---------- Boot
    function loadCSV(){
      if(!window.Papa){
        els.stats.textContent = 'Erro: biblioteca de leitura (PapaParse) não carregou.';
        return;
      }
      Papa.parse(CSV_URL, {
        download:true, header:true, skipEmptyLines:true,
        complete:function(res){
          try{
            hasCategoria = false;
            var rows = res.data || [];
            master = rows.map(normalizeRow).filter(function(r){ return r.titulo && r.url; });
            master.sort(byDateDesc);
            populateCategoriaFilter();
            applyFilters();
          }catch(err){
            console.error('Falha ao processar CSV:', err);
            showDemo('Falha ao processar CSV.');
          }
        },
        error:function(err){
          console.error('Erro CSV:', err);
          showDemo('Erro ao baixar o CSV publicado.');
        }
      });
    }

    function showDemo(reason){
      els.stats.textContent = (reason || 'Dados indisponíveis.') + ' Exibindo exemplos.';
      hasCategoria = true;
      master = [
        {categoria:'Soja', __categoria:'soja', titulo:'Exemplo 1', veiculo:'Demo', data:'2025-09-03', __date:'03 set 2025', __ts:1693699200000, url:'#', escopo:'Nacional', __esc:'nacional'},
        {categoria:'Café', __categoria:'cafe', titulo:'Exemplo 2', veiculo:'Demo', data:'2025-09-01', __date:'01 set 2025', __ts:1693526400000, url:'#', escopo:'Internacional', __esc:'internacional'},
        {categoria:'Açúcar', __categoria:'acucar', titulo:'Exemplo 3', veiculo:'Demo', data:'2025-08-28', __date:'28 ago 2025', __ts:1693180800000, url:'#', escopo:'Nacional', __esc:'nacional'}
      ];
      populateCategoriaFilter();
      applyFilters();
    }

    window.addEventListener('load', loadCSV);
  })();
  </script>
</body>
</html>
